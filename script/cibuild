#!/usr/bin/env bash
set -o errexit
set -o nounset

echo "MSYSTEM=${MSYSTEM}"

export VCV_BUILD_DIR="C:\projects"
export VCV_BUILD_TAG="${APPVEYOR_REPO_TAG_NAME:-notag}"
export VCV_CHECKOUT_DIR="${APPVEYOR_BUILD_FOLDER}"

export VCV_RACK_BUILD_DIR="${VCV_BUILD_DIR}/Rack"
export VCV_RACK_PLUGINS_DIR="${VCV_RACK_BUILD_DIR}/plugins"

export VCV_PLUGIN_NAME=DHE-Modules
export VCV_PLUGIN_ARTIFACT_DIR="${VCV_CHECKOUT_DIR}/artifacts"
export VCV_PLUGIN_ARTIFACT_FILE_NAME="${VCV_PLUGIN_NAME}-${VCV_BUILD_TAG}-win.zip"
export VCV_PLUGIN_ARTIFACT_FILE_PATH="${VCV_PLUGIN_ARTIFACT_DIR}/${VCV_PLUGIN_ARTIFACT_FILE_NAME}"
export VCV_PLUGIN_BUILD_DIR="${VCV_RACK_PLUGINS_DIR}/${VCV_PLUGIN_NAME}"
export VCV_PLUGIN_DIST_DIR="${VCV_PLUGIN_BUILD_DIR}/dist"
export VCV_PLUGIN_DIST_FILE_PATH="${VCV_PLUGIN_DIST_DIR}/${VCV_PLUGIN_ARTIFACT_FILE_NAME}"

env | sort

set -o xtrace

git clone https://github.com/VCVRack/Rack.git "${VCV_RACK_BUILD_DIR}" || true
cd "${VCV_RACK_BUILD_DIR}"
git pull
git submodule update --init --recursive
make dep > /dev/null
make

cp -r "${VCV_CHECKOUT_DIR}" "${VCV_PLUGIN_BUILD_DIR}"
cd "${VCV_PLUGIN_BUILD_DIR}"
make clean test dist VERSION="${VCV_BUILD_TAG}"

mkdir -p "${VCV_PLUGIN_ARTIFACT_DIR}"
mv "${VCV_PLUGIN_DIST_FILE_PATH}" "${VCV_PLUGIN_ARTIFACT_DIR}"
